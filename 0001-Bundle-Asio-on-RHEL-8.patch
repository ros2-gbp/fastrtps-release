From 31e16ab9eb35bc50d268168a03d4abadb95d514b Mon Sep 17 00:00:00 2001
From: Scott K Logan <logans@cottsay.net>
Date: Thu, 11 Mar 2021 16:48:28 -0800
Subject: [PATCH] Bundle Asio on RHEL 8

Asio is not currently available for RHEL 8, but it appears that Fast-DDS
is able to bundle it. Rather than introduce an Asio package to the
bootstrap repository just for this package, we can flip this flag to
bundle it.

The CMake logic in Fast-DDS expects the sources to be in a git
repository, and uses submodules to download the bundled sources. When
the package is bloomed, the submodules are initialized and included in
the tarball, but the sources are no longer part of a git repository.
Since we know that the directory has already been populated, we need to
suppress the submodule initialization and update step.

Signed-off-by: Scott K Logan <logans@cottsay.net>
---
 cmake/common/eprosima_libraries.cmake | 4 ++--
 package.xml                           | 1 -
 rpm/ros-rolling-fastrtps.spec         | 2 +-
 3 files changed, 3 insertions(+), 4 deletions(-)

diff --git a/cmake/common/eprosima_libraries.cmake b/cmake/common/eprosima_libraries.cmake
index fe8d9797..9a5b25dd 100644
--- a/cmake/common/eprosima_libraries.cmake
+++ b/cmake/common/eprosima_libraries.cmake
@@ -98,7 +98,7 @@ macro(eprosima_find_package package)
             # Update submodule
             message(STATUS "Updating submodule thirdparty/${package}")
             execute_process(
-                COMMAND git submodule update --recursive --init "thirdparty/${package}"
+                COMMAND echo "Submodules were already updated by Bloom - see ros2-gbp/fastrtps-release#15"
                 WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
                 RESULT_VARIABLE EXECUTE_RESULT
                 )
@@ -221,7 +221,7 @@ macro(eprosima_find_thirdparty package thirdparty_name)
             # Update submodule
             message(STATUS "Updating submodule thirdparty/${thirdparty_name}")
             execute_process(
-                COMMAND git submodule update --recursive --init "thirdparty/${thirdparty_name}"
+                COMMAND echo "Submodules were already updated by Bloom - see ros2-gbp/fastrtps-release#15"
                 WORKING_DIRECTORY ${PROJECT_SOURCE_DIR}
                 RESULT_VARIABLE EXECUTE_RESULT
                 )
diff --git a/package.xml b/package.xml
index 8543c43c..0c9755cb 100644
--- a/package.xml
+++ b/package.xml
@@ -7,7 +7,6 @@
   <maintainer email="stevenragnarok@osrfoundation.org">Steven! Ragnar√∂k</maintainer>
   <license>Apache License 2.0</license>
 
-  <build_depend>asio</build_depend>
   <build_depend>libssl-dev</build_depend>
 
   <build_export_depend>libssl-dev</build_export_depend>
diff --git a/rpm/ros-rolling-fastrtps.spec b/rpm/ros-rolling-fastrtps.spec
index c8e27402..45e9fdcc 100644
--- a/rpm/ros-rolling-fastrtps.spec
+++ b/rpm/ros-rolling-fastrtps.spec
@@ -18,7 +18,6 @@ Requires:       ros-rolling-fastcdr
 Requires:       ros-rolling-foonathan-memory-vendor
 Requires:       tinyxml2-devel
 Requires:       ros-rolling-ros-workspace
-BuildRequires:  asio-devel
 BuildRequires:  cmake3
 BuildRequires:  openssl-devel
 BuildRequires:  ros-rolling-fastcdr
@@ -52,6 +51,7 @@ mkdir -p obj-%{_target_platform} && cd obj-%{_target_platform}
     -DSETUPTOOLS_DEB_LAYOUT=OFF \
     -DINSTALL_EXAMPLES=OFF \
     -DSECURITY=ON \
+    -DTHIRDPARTY_Asio=ON \
     ..
 
 %make_build
-- 
2.25.1

